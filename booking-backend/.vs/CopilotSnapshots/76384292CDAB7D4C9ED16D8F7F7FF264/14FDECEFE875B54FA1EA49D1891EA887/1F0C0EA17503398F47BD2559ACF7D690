using Microsoft.AspNetCore.Mvc;
using booking_backend.DTOs.Otp;
using booking_backend.Services.Otp;

namespace booking_backend.Controllers;

/// <summary>
/// API controller for OTP operations
/// </summary>
[ApiController]
[Route("api/[controller]")]
public class OtpController : ControllerBase
{
    private readonly IOtpService _otpService;
    private readonly ILogger<OtpController> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="OtpController"/> class.
    /// </summary>
    /// <param name="otpService">The OTP service</param>
    /// <param name="logger">The logger instance</param>
    public OtpController(IOtpService otpService, ILogger<OtpController> logger)
    {
        _otpService = otpService;
        _logger = logger;
    }

    /// <summary>
    /// Requests an OTP code for the specified phone number
    /// </summary>
    /// <param name="request">The OTP request containing phone number</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>OTP request response</returns>
    [HttpPost("request")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status429TooManyRequests)]
    public async Task<IActionResult> RequestOtp(
        [FromBody] RequestOtpDto request,
        CancellationToken cancellationToken)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(request.PhoneNumber))
            {
                return BadRequest(new OtpRequestResponseDto(
                    false,
                    "Phone number is required",
                    null,
                    0));
            }

            var result = await _otpService.GenerateAndSendOtpAsync(request.PhoneNumber, cancellationToken);

            if (!result.Success)
            {
                // Check if rate limited
                if (result.Message.Contains("Too many"))
                {
                    return StatusCode(StatusCodes.Status429TooManyRequests, result);
                }

                return BadRequest(result);
            }

            return Ok(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error requesting OTP");
            return StatusCode(StatusCodes.Status500InternalServerError, 
                new OtpRequestResponseDto(
                    false,
                    "An error occurred while processing your request",
                    null,
                    0));
        }
    }

    /// <summary>
    /// Verifies an OTP code
    /// </summary>
    /// <param name="request">The OTP verification request</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>Verification response</returns>
    [HttpPost("verify")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status401Unauthorized)]
    public async Task<IActionResult> VerifyOtp(
        [FromBody] VerifyOtpDto request,
        CancellationToken cancellationToken)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(request.PhoneNumber) || string.IsNullOrWhiteSpace(request.Code))
            {
                return BadRequest(new OtpVerificationResponseDto(
                    false,
                    "Phone number and OTP code are required",
                    false));
            }

            var result = await _otpService.VerifyOtpAsync(request.PhoneNumber, request.Code, cancellationToken);

            if (!result.Success)
            {
                return Unauthorized(result);
            }

            return Ok(result);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error verifying OTP");
            return StatusCode(StatusCodes.Status500InternalServerError, 
                new OtpVerificationResponseDto(
                    false,
                    "An error occurred during verification",
                    false));
        }
    }

    /// <summary>
    /// Gets the number of OTP requests remaining for a phone number
    /// </summary>
    /// <param name="phoneNumber">The phone number</param>
    /// <returns>Remaining attempts</returns>
    [HttpGet("remaining-attempts/{phoneNumber}")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    public IActionResult GetRemainingAttempts([FromRoute] string phoneNumber)
    {
        try
        {
            if (string.IsNullOrWhiteSpace(phoneNumber))
            {
                return BadRequest(new { message = "Phone number is required" });
            }

            var remaining = _otpService.GetRemainingAttempts(phoneNumber);
            return Ok(new { phoneNumber, remainingAttempts = remaining });
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error getting remaining attempts");
            return StatusCode(StatusCodes.Status500InternalServerError, 
                new { message = "An error occurred" });
        }
    }
}

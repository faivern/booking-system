using Microsoft.AspNetCore.Mvc;
using booking_backend.DTOs.Bookings;
using booking_backend.Services.Bookings;

namespace booking_backend.Controllers;

/// <summary>
/// API controller for managing bookings
/// </summary>
[ApiController]
[Route("api/[controller]")]
public class BookingsController : ControllerBase
{
    private readonly IBookingService _bookingService;
    private readonly ILogger<BookingsController> _logger;

    /// <summary>
    /// Initializes a new instance of the <see cref="BookingsController"/> class.
    /// </summary>
    /// <param name="bookingService">The booking service</param>
    /// <param name="logger">The logger instance</param>
    public BookingsController(IBookingService bookingService, ILogger<BookingsController> logger)
    {
        _bookingService = bookingService;
        _logger = logger;
    }

    /// <summary>
    /// Creates a new booking
    /// </summary>
    /// <param name="request">The booking creation request</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>The created booking</returns>
    [HttpPost]
    [ProducesResponseType(StatusCodes.Status201Created)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status409Conflict)]
    public async Task<IActionResult> CreateBooking(
        [FromBody] CreateBookingDto request,
        CancellationToken cancellationToken)
    {
        try
        {
            var result = await _bookingService.CreateBookingAsync(request, cancellationToken);
            return CreatedAtAction(nameof(GetBookingById), new { id = result.BookingId }, result);
        }
        catch (ArgumentException ex)
        {
            _logger.LogWarning(ex, "Validation error while creating booking");
            return BadRequest(new { message = ex.Message });
        }
        catch (InvalidOperationException ex)
        {
            _logger.LogWarning(ex, "Business logic error while creating booking");
            return Conflict(new { message = ex.Message });
        }
    }

    /// <summary>
    /// Retrieves a booking by ID
    /// </summary>
    /// <param name="id">The booking ID</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>The booking details</returns>
    [HttpGet("{id}")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<IActionResult> GetBookingById(
        [FromRoute] int id,
        CancellationToken cancellationToken)
    {
        var result = await _bookingService.GetBookingByIdAsync(id, cancellationToken);
        
        if (result == null)
        {
            return NotFound(new { message = $"Booking {id} not found" });
        }

        return Ok(result);
    }

    /// <summary>
    /// Retrieves all bookings for a customer
    /// </summary>
    /// <param name="customerId">The customer ID</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>List of customer bookings</returns>
    [HttpGet("customer/{customerId}")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    public async Task<IActionResult> GetCustomerBookings(
        [FromRoute] int customerId,
        CancellationToken cancellationToken)
    {
        var result = await _bookingService.GetCustomerBookingsAsync(customerId, cancellationToken);
        return Ok(result);
    }

    /// <summary>
    /// Retrieves all bookings for a business
    /// </summary>
    /// <param name="businessId">The business ID</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>List of business bookings</returns>
    [HttpGet("business/{businessId}")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    public async Task<IActionResult> GetBusinessBookings(
        [FromRoute] int businessId,
        CancellationToken cancellationToken)
    {
        var result = await _bookingService.GetBusinessBookingsAsync(businessId, cancellationToken);
        return Ok(result);
    }

    /// <summary>
    /// Updates an existing booking
    /// </summary>
    /// <param name="id">The booking ID</param>
    /// <param name="request">The booking update request</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>The updated booking</returns>
    [HttpPut("{id}")]
    [ProducesResponseType(StatusCodes.Status200OK)]
    [ProducesResponseType(StatusCodes.Status400BadRequest)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    [ProducesResponseType(StatusCodes.Status409Conflict)]
    public async Task<IActionResult> UpdateBooking(
        [FromRoute] int id,
        [FromBody] UpdateBookingDto request,
        CancellationToken cancellationToken)
    {
        try
        {
            var result = await _bookingService.UpdateBookingAsync(id, request, cancellationToken);
            
            if (result == null)
            {
                return NotFound(new { message = $"Booking {id} not found" });
            }

            return Ok(result);
        }
        catch (ArgumentException ex)
        {
            _logger.LogWarning(ex, "Validation error while updating booking");
            return BadRequest(new { message = ex.Message });
        }
        catch (InvalidOperationException ex)
        {
            _logger.LogWarning(ex, "Business logic error while updating booking");
            return Conflict(new { message = ex.Message });
        }
    }

    /// <summary>
    /// Deletes a booking
    /// </summary>
    /// <param name="id">The booking ID</param>
    /// <param name="cancellationToken">Cancellation token</param>
    /// <returns>No content</returns>
    [HttpDelete("{id}")]
    [ProducesResponseType(StatusCodes.Status204NoContent)]
    [ProducesResponseType(StatusCodes.Status404NotFound)]
    public async Task<IActionResult> DeleteBooking(
        [FromRoute] int id,
        CancellationToken cancellationToken)
    {
        var result = await _bookingService.DeleteBookingAsync(id, cancellationToken);
        
        if (!result)
        {
            return NotFound(new { message = $"Booking {id} not found" });
        }

        return NoContent();
    }
}

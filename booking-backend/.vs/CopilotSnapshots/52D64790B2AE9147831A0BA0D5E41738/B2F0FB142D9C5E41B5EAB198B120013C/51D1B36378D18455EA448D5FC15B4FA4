using Microsoft.EntityFrameworkCore;
using booking_backend.Data;
using booking_backend.DTOs.Otp;
using booking_backend.Models;
using booking_backend.Services.Sms;

namespace booking_backend.Services.Otp;

/// <summary>
/// Service for managing OTP authentication
/// Implements best practices: 6-digit code, 2-minute expiry, rate limiting
/// </summary>
public class OtpService : IOtpService
{
    private readonly BookingSystemDbContext _context;
    private readonly ISmsService _smsService;
    private readonly ILogger<OtpService> _logger;
    
    // Configuration constants
    private const int OtpExpiryMinutes = 2;
    private const int OtpLength = 6;
    private const int MaxAttempts = 3;
    private const int AttemptsResetMinutes = 15;
    
    // In-memory store for attempt tracking (could be moved to cache for scalability)
    private static readonly Dictionary<string, (int Attempts, DateTime ResetTime)> _attemptTracker = [];

    /// <summary>
    /// Initializes a new instance of the <see cref="OtpService"/> class.
    /// </summary>
    /// <param name="context">The database context.</param>
    /// <param name="smsService">The SMS service.</param>
    /// <param name="logger">The logger instance.</param>
    public OtpService(
        BookingSystemDbContext context,
        ISmsService smsService,
        ILogger<OtpService> logger)
    {
        _context = context;
        _smsService = smsService;
        _logger = logger;
    }

    /// <summary>
    /// Generates and sends an OTP code to the specified phone number
    /// </summary>
    public async Task<OtpRequestResponseDto> GenerateAndSendOtpAsync(string phoneNumber, CancellationToken cancellationToken = default)
    {
        try
        {
            // Validate phone number
            if (string.IsNullOrWhiteSpace(phoneNumber) || !IsValidPhoneFormat(phoneNumber))
            {
                _logger.LogWarning("Invalid phone number format: {PhoneNumber}", phoneNumber);
                return new OtpRequestResponseDto(
                    false,
                    "Invalid phone number format",
                    null,
                    0);
            }

            // Check rate limiting
            if (!CheckRateLimit(phoneNumber))
            {
                _logger.LogWarning("Rate limit exceeded for phone {PhoneNumber}", phoneNumber);
                return new OtpRequestResponseDto(
                    false,
                    "Too many OTP requests. Please try again later.",
                    null,
                    0);
            }

            // Generate OTP code
            var code = GenerateOtpCode();
            var expiresAt = DateTime.UtcNow.AddMinutes(OtpExpiryMinutes);

            // Delete any previous unused OTP for this phone
            var existingOtps = await _context.OtpCodes
                .Where(o => o.Phone == phoneNumber && !o.Used)
                .ToListAsync(cancellationToken);

            if (existingOtps.Any())
            {
                _context.OtpCodes.RemoveRange(existingOtps);
                await _context.SaveChangesAsync(cancellationToken);
            }

            // Create new OTP record
            var otpCode = new OtpCode
            {
                Phone = phoneNumber,
                Code = code,
                ExpiresAt = expiresAt,
                Used = false
            };

            _context.OtpCodes.Add(otpCode);
            await _context.SaveChangesAsync(cancellationToken);

            // Send SMS
            var smsMessage = $"Your OTP code is: {code}. Valid for 2 minutes. Do not share this code.";
            var smsSent = await _smsService.SendSmsAsync(phoneNumber, smsMessage, cancellationToken);

            if (!smsSent)
            {
                _logger.LogError("Failed to send SMS to {PhoneNumber}", phoneNumber);
                return new OtpRequestResponseDto(
                    false,
                    "Failed to send OTP. Please try again.",
                    null,
                    0);
            }

            _logger.LogInformation("OTP generated and sent successfully to {PhoneNumber}", phoneNumber);

            return new OtpRequestResponseDto(
                true,
                "OTP sent successfully to your phone",
                phoneNumber,
                OtpExpiryMinutes * 60); // Return expiry in seconds
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error generating OTP for phone {PhoneNumber}", phoneNumber);
            return new OtpRequestResponseDto(
                false,
                "An error occurred. Please try again.",
                null,
                0);
        }
    }

    /// <summary>
    /// Verifies an OTP code for the specified phone number
    /// </summary>
    public async Task<OtpVerificationResponseDto> VerifyOtpAsync(string phoneNumber, string code, CancellationToken cancellationToken = default)
    {
        try
        {
            // Validate inputs
            if (string.IsNullOrWhiteSpace(phoneNumber) || string.IsNullOrWhiteSpace(code))
            {
                return new OtpVerificationResponseDto(
                    false,
                    "Phone number and OTP code are required",
                    false);
            }

            // Find the most recent OTP for this phone
            var otpRecord = await _context.OtpCodes
                .Where(o => o.Phone == phoneNumber && !o.Used)
                .OrderByDescending(o => o.OtpCodeId)
                .FirstOrDefaultAsync(cancellationToken);

            if (otpRecord == null)
            {
                _logger.LogWarning("No valid OTP found for phone {PhoneNumber}", phoneNumber);
                return new OtpVerificationResponseDto(
                    false,
                    "No OTP request found. Please request a new OTP.",
                    false);
            }

            // Check if OTP has expired
            if (DateTime.UtcNow > otpRecord.ExpiresAt)
            {
                _logger.LogWarning("OTP expired for phone {PhoneNumber}", phoneNumber);
                return new OtpVerificationResponseDto(
                    false,
                    "OTP has expired. Please request a new one.",
                    false);
            }

            // Verify the code (case-sensitive)
            if (otpRecord.Code != code.Trim())
            {
                _logger.LogWarning("Invalid OTP code provided for phone {PhoneNumber}", phoneNumber);
                return new OtpVerificationResponseDto(
                    false,
                    "Invalid OTP code",
                    false);
            }

            // Mark OTP as used
            otpRecord.Used = true;
            _context.OtpCodes.Update(otpRecord);
            await _context.SaveChangesAsync(cancellationToken);

            // Clear attempt tracker on successful verification
            _attemptTracker.Remove(phoneNumber);

            _logger.LogInformation("OTP verified successfully for phone {PhoneNumber}", phoneNumber);

            return new OtpVerificationResponseDto(
                true,
                "OTP verified successfully",
                true);
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error verifying OTP for phone {PhoneNumber}", phoneNumber);
            return new OtpVerificationResponseDto(
                false,
                "An error occurred during verification",
                false);
        }
    }

    /// <summary>
    /// Gets the number of OTP attempts remaining for a phone number
    /// </summary>
    public int GetRemainingAttempts(string phoneNumber)
    {
        if (!_attemptTracker.TryGetValue(phoneNumber, out var data))
        {
            return MaxAttempts;
        }

        // Check if reset time has passed
        if (DateTime.UtcNow > data.ResetTime)
        {
            _attemptTracker.Remove(phoneNumber);
            return MaxAttempts;
        }

        return Math.Max(0, MaxAttempts - data.Attempts);
    }

    /// <summary>
    /// Cleans up expired OTP codes from the database
    /// Call this periodically (e.g., via background job)
    /// </summary>
    public async Task CleanupExpiredOtpsAsync(CancellationToken cancellationToken = default)
    {
        try
        {
            var expiredOtps = await _context.OtpCodes
                .Where(o => DateTime.UtcNow > o.ExpiresAt)
                .ToListAsync(cancellationToken);

            if (expiredOtps.Any())
            {
                _context.OtpCodes.RemoveRange(expiredOtps);
                await _context.SaveChangesAsync(cancellationToken);
                _logger.LogInformation("Cleaned up {Count} expired OTP codes", expiredOtps.Count);
            }
        }
        catch (Exception ex)
        {
            _logger.LogError(ex, "Error cleaning up expired OTP codes");
        }
    }

    /// <summary>
    /// Generates a random 6-digit OTP code
    /// </summary>
    private static string GenerateOtpCode()
    {
        using (var rng = new System.Security.Cryptography.RNGCryptoServiceProvider())
        {
            byte[] tokenData = new byte[4];
            rng.GetBytes(tokenData);
            int randomNumber = Math.Abs(BitConverter.ToInt32(tokenData, 0)) % 1000000;
            return randomNumber.ToString().PadLeft(OtpLength, '0');
        }
    }

    /// <summary>
    /// Validates phone number format
    /// </summary>
    private static bool IsValidPhoneFormat(string phoneNumber)
    {
        return System.Text.RegularExpressions.Regex.IsMatch(
            phoneNumber,
            @"^\+?[\d\s\-()]{7,}$");
    }

    /// <summary>
    /// Checks if phone number has exceeded rate limit
    /// </summary>
    private bool CheckRateLimit(string phoneNumber)
    {
        if (!_attemptTracker.TryGetValue(phoneNumber, out var data))
        {
            // First request for this phone
            _attemptTracker[phoneNumber] = (1, DateTime.UtcNow.AddMinutes(AttemptsResetMinutes));
            return true;
        }

        // Check if reset time has passed
        if (DateTime.UtcNow > data.ResetTime)
        {
            // Reset attempts
            _attemptTracker[phoneNumber] = (1, DateTime.UtcNow.AddMinutes(AttemptsResetMinutes));
            return true;
        }

        // Check if max attempts exceeded
        if (data.Attempts >= MaxAttempts)
        {
            return false;
        }

        // Increment attempts
        _attemptTracker[phoneNumber] = (data.Attempts + 1, data.ResetTime);
        return true;
    }
}
